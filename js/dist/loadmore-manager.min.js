/*! HOLY LABEL LoadMore Manager v1.0.0 | (c) 2024 | MIT License */
/**
 * HOLY LABEL - Load More Manager Library
 * Ajax pagination and load more functionality
 * @version 1.0.0
 * @namespace window.HolyLabelLoadMoreManager
 * @requires window.HolyLabelDOMUtils
 */
!function(t){"use strict";const e={elements:{get btn(){return(t.HolyLabelDOMUtils||t.DOMUtils).getId("load-more-btn")},get maxPage(){return(t.HolyLabelDOMUtils||t.DOMUtils).getId("max_page")},get nextPage(){return(t.HolyLabelDOMUtils||t.DOMUtils).getId("next_page")},get productGrid(){return(t.HolyLabelDOMUtils||t.DOMUtils).getId("product-grid")}},loading:!1,init(){const{btn:t}=this.elements;t&&(this.updateButtonVisibility(),t.addEventListener("click",()=>this.loadMore()),this.initInfiniteScroll())},updateButtonVisibility(){const{btn:t,maxPage:e,nextPage:s}=this.elements;if(!t||!e||!s)return;const n=parseInt(s.textContent||"1",10)-1,i=parseInt(e.textContent||"1",10);t.style.display=n>=i?"none":"block"},async loadMore(){if(this.loading)return;const{btn:t,nextPage:e,productGrid:s}=this.elements;if(!t||!e||!s)return;this.loading=!0;const n=parseInt(e.textContent||"1",10);this.setLoadingState(!0);try{const t=await this.fetchMoreItems(n);t.success&&t.items?(this.appendItems(t.items),e.textContent=n+1,this.updateButtonVisibility(),this.animateNewItems()):this.showError("商品の読み込みに失敗しました。")}catch(t){console.error("Load more error:",t),this.showError("ネットワークエラーが発生しました。")}finally{this.loading=!1,this.setLoadingState(!1)}},async fetchMoreItems(e){const s=new URL(t.location.href);s.searchParams.set("page",e);const n=await fetch(s.toString(),{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const i=await n.text();return this.parseResponse(i)},parseResponse(t){const e=(new DOMParser).parseFromString(t,"text/html").querySelectorAll(".product-item");return{success:e.length>0,items:Array.from(e).map(t=>t.outerHTML)}},appendItems(t){const{productGrid:e}=this.elements;if(!e)return;const s=document.createDocumentFragment();t.forEach(t=>{const e=document.createElement("div");e.innerHTML=t;const n=e.firstElementChild;n&&(n.classList.add("new-item"),s.appendChild(n))}),e.appendChild(s)},animateNewItems(){const DOMUtils=t.HolyLabelDOMUtils||t.DOMUtils,e=t.HolyLabelAnimationManager||t.AnimationManager;DOMUtils.getAll(".product-item.new-item").forEach((t,e)=>{t.style.opacity="0",t.style.transform="translateY(30px)",setTimeout(()=>{t.style.transition="opacity 0.6s ease, transform 0.6s ease",t.style.opacity="1",t.style.transform="translateY(0)",setTimeout(()=>{t.classList.remove("new-item"),t.style.transition=""},600)},100*e)}),e&&e.animateOnScroll&&setTimeout(()=>{e.animateOnScroll()},100)},setLoadingState(t){const{btn:e}=this.elements;e&&(t?(e.disabled=!0,e.textContent="読み込み中...",e.classList.add("loading")):(e.disabled=!1,e.textContent="もっと見る",e.classList.remove("loading")))},showError(e){t.HolyLabelModalUtils?t.HolyLabelModalUtils.alert(e):alert(e)},initInfiniteScroll(){if(!this.isInfiniteScrollEnabled())return;let e=!1;t.addEventListener("scroll",()=>{e||(requestAnimationFrame(()=>{t.scrollY+t.innerHeight>=document.documentElement.scrollHeight-200&&this.loadMore(),e=!1}),e=!0)},{passive:!0})},isInfiniteScrollEnabled:()=>"true"===document.body.dataset.infiniteScroll||document.body.classList.contains("infinite-scroll"),initSearchFilter(){const e=(t.HolyLabelDOMUtils||t.DOMUtils).get(".search-form");e&&e.addEventListener("submit",t=>{this.isAjaxSearchEnabled()&&(t.preventDefault(),this.performAjaxSearch())})},isAjaxSearchEnabled:()=>"true"===document.body.dataset.ajaxSearch,async performAjaxSearch(){}};t.HolyLabelLoadMoreManager=e,t.LoadMoreManager||(t.LoadMoreManager=e)}(window);